import nltk
import re


class FrequencyAnalysis:
    def __init__(self, alphabet):
        self.caracters_frequency = None
        self.corpus_caracters_frequency = None
        self.alphabet = alphabet

    def set_letters_frequency_from_nltk_corpus(self, corpus_names):
        """
        Download one or more corpus from nltk database to set average of caracter repetition (sequential analysis) of each corpus downloaded.

        :param corpus_names: list of strings
        :return: None


        >>> from cryptalib.alphabets import charsets
        >>> fa = FrequencyAnalysis(charsets["monoalphabetic_character_alphabet"])
        >>> fa.set_letters_frequency_from_nltk_corpus(['gutenberg', 'brown'])
        loading file austen-emma.txt from corpus gutenberg
        loading file austen-persuasion.txt from corpus gutenberg
        loading file austen-sense.txt from corpus gutenberg
        loading file bible-kjv.txt from corpus gutenberg
        loading file blake-poems.txt from corpus gutenberg
        loading file bryant-stories.txt from corpus gutenberg
        loading file burgess-busterbrown.txt from corpus gutenberg
        loading file carroll-alice.txt from corpus gutenberg
        loading file chesterton-ball.txt from corpus gutenberg
        loading file chesterton-brown.txt from corpus gutenberg
        loading file chesterton-thursday.txt from corpus gutenberg
        loading file edgeworth-parents.txt from corpus gutenberg
        loading file melville-moby_dick.txt from corpus gutenberg
        loading file milton-paradise.txt from corpus gutenberg
        loading file shakespeare-caesar.txt from corpus gutenberg
        loading file shakespeare-hamlet.txt from corpus gutenberg
        loading file shakespeare-macbeth.txt from corpus gutenberg
        loading file whitman-leaves.txt from corpus gutenberg
        loading file cats.txt from corpus brown

        >>> fa.caracters_frequency
        {'a': 0.056394041655315086, 'b': 0.01117330435656253, 'c': 0.01892761325269515, 'd': 0.031428067066180954, 'e': 0.0965456804507911, 'f': 0.015256070417674166, 'g': 0.014666192674799012, 'h': 0.04681532609696492, 'i': 0.04496026583322259, 'j': 0.0011934667958262719, 'k': 0.005978233953028737, 'l': 0.03323422836795962, 'm': 0.017792061737417483, 'n': 0.049828004488971823, 'o': 0.05514302761752615, 'p': 0.010581058859192362, 'q': 0.0006293274229456359, 'r': 0.04386287427499078, 's': 0.04568217498544893, 't': 0.06433625077874919, 'u': 0.021918058981976594, 'v': 0.006475604754084913, 'w': 0.016157686377858953, 'x': 0.000820947886682903, 'y': 0.015031294668794506, 'z': 0.0003069880481702607}

        >>> fa.corpus_caracters_frequency
        {'austen-emma.txt': {'a': 0.06050135783945141, 'b': 0.011873908627381575, 'c': 0.016701030695400933, 'd': 0.03193430965503325, 'e': 0.09527760461113034, 'f': 0.016456405406106163, 'g': 0.01524680662539977, 'h': 0.04602562816279644, 'i': 0.04801194041965074, 'j': 0.000775586170667286, 'k': 0.004904906146182211, 'l': 0.03104486563082324, 'm': 0.020188913852442477, 'n': 0.05296757531246089, 'o': 0.05962656878648947, 'p': 0.011593209562706932, 'q': 0.0010089384051558444, 'r': 0.045879078450315705, 's': 0.04684517924720795, 't': 0.06546150195418406, 'u': 0.023228129428196843, 'v': 0.008618250399347967, 'w': 0.01683630735307546, 'x': 0.0015173531769159402, 'y': 0.01721057277264165, 'z': 0.00019727845910868464}, 'austen-persuasion.txt': {'a': 0.0612298731267103, 'b': 0.011514244293275458, 'c': 0.017932969040858518, 'd': 0.03234882863098659, 'e': 0.09973578787540854, 'f': 0.01724027004537929, 'g': 0.015400221320545924, 'h': 0.048488929683545935, 'i': 0.04913873710035772, 'j': 0.0006862652586791109, 'k': 0.004477880812881199, 'l': 0.03179552726617656, 'm': 0.01831041493313203, 'n': 0.057052233364501215, 'o': 0.058995221878136446, 'p': 0.01231631681435667, 'q': 0.0010658557298859942, 'r': 0.04585753133229822, 's': 0.047007025640585724, 't': 0.06774510392629511, 'u': 0.021377162807854306, 'v': 0.008734869995625059, 'w': 0.017521209885651052, 'x': 0.0011194702032202998, 'y': 0.015895619054154906, 'z': 0.0003066747874722277}, 'austen-sense.txt': {'a': 0.059274436794042394, 'b': 0.010886716927529858, 'c': 0.017913233148396338, 'd': 0.03239418622273863, 'e': 0.09713352609572941, 'f': 0.017789908799415177, 'g': 0.014105036685279232, 'h': 0.04678004582316774, 'i': 0.05065064737854037, 'j': 0.0008023511861425035, 'k': 0.004117250253334957, 'l': 0.030010906032789417, 'm': 0.018965204703560952, 'n': 0.05669056880755755, 'o': 0.06203660504411446, 'p': 0.011432018567000782, 'q': 0.0008944729889959021, 'r': 0.04913955264463866, 's': 0.047621028733087475, 't': 0.06557735111185073, 'u': 0.02176303300635046, 'v': 0.008672821987988506, 'w': 0.01791026147733655, 'x': 0.0012481018451105611, 'y': 0.01694149671184597, 'z': 0.00010252265156265323}, 'bible-kjv.txt': {'a': 0.05929020157625271, 'b': 0.010137438563950963, 'c': 0.0121895768639006, 'd': 0.034350870179575374, 'e': 0.09412877485196953, 'f': 0.018657355453619275, 'g': 0.011259871198373985, 'h': 0.06438904165995392, 'i': 0.04146145668351739, 'j': 0.0005608701010997208, 'k': 0.004988743360152002, 'l': 0.027763300815177375, 'm': 0.017666023320194048, 'n': 0.0512838385857395, 'o': 0.05377890269803908, 'p': 0.009472011197090676, 'q': 0.00021880858265124913, 'r': 0.03731401847501497, 's': 0.042567501755315686, 't': 0.0712187314918637, 'u': 0.01908297046037972, 'v': 0.006959405468460404, 'w': 0.014500454004727928, 'x': 0.0003346755747302861, 'y': 0.01332031868500658, 'z': 0.0004768549913053594}, 'blake-poems.txt': {'a': 0.049301496605771496, 'b': 0.009671585458548475, 'c': 0.010693785547663355, 'd': 0.03331323880166697, 'e': 0.09535292113333159, 'f': 0.013393442193274447, 'g': 0.01491363719759914, 'h': 0.04898697350142846, 'i': 0.04159568054936702, 'j': 0.0009435693130291196, 'k': 0.006054569758603518, 'l': 0.033889864492962544, 'm': 0.017403611773648207, 'n': 0.048488978586218645, 'o': 0.044845752627578436, 'p': 0.010641365030272848, 'q': 7.863077608575997e-05, 'r': 0.04251303960370089, 's': 0.04133357796241449, 't': 0.05325924566875475, 'u': 0.014887426938903887, 'v': 0.0075747647629282105, 'w': 0.016984247634524153, 'x': 0.00020968206956202657, 'y': 0.01729877073886719, 'z': 0.00018347181086677327}, 'bryant-stories.txt': {'a': 0.058964315924935555, 'b': 0.009244745208247307, 'c': 0.01296509367019592, 'd': 0.03567605707206972, 'e': 0.09367019591964368, 'f': 0.013133471510068594, 'g': 0.015967831814591944, 'h': 0.05475086093193125, 'i': 0.04340540172146296, 'j': 0.000653466378553474, 'k': 0.00797389341682736, 'l': 0.03350719013466218, 'm': 0.01587963389846816, 'n': 0.04587494337292885, 'o': 0.05342789219007453, 'p': 0.010094652399985568, 'q': 0.00033675567974534855, 'r': 0.03963293630907757, 's': 0.0409559050509343, 't': 0.06897878840117223, 'u': 0.01892647100092608, 'v': 0.005688765589983924, 'w': 0.018870345054301855, 'x': 0.0006173854128664724, 'y': 0.014388287316738762, 'z': 0.00025657575599645607}, 'burgess-busterbrown.txt': {'a': 0.057971014492753624, 'b': 0.010783931587588438, 'c': 0.011350885274559134, 'd': 0.03180846414608507, 'e': 0.09582698463319278, 'f': 0.015354995688789673, 'g': 0.015874703235179477, 'h': 0.051817204682092534, 'i': 0.0419191382303958, 'j': 0.0011693419793770597, 'k': 0.008008220828461076, 'l': 0.029457968652185723, 'm': 0.015945572446050812, 'n': 0.042923118717739746, 'o': 0.05368342723503774, 'p': 0.00903582438609546, 'q': 0.0004370268003732445, 'r': 0.0431593494206442, 's': 0.04106870769993976, 't': 0.07355042934930253, 'u': 0.02174503620235522, 'v': 0.005397871561366831, 'w': 0.018992948513518303, 'x': 0.0006496344329872554, 'y': 0.014858911212690314, 'z': 0.00029528837863057063}, 'carroll-alice.txt': {'a': 0.056470099380172445, 'b': 0.009591744866511999, 'c': 0.015616884241144083, 'd': 0.03284047231552339, 'e': 0.09273866823643478, 'f': 0.013345337442432216, 'g': 0.01695349561965442, 'h': 0.049101423179472976, 'i': 0.04697531077945912, 'j': 0.0009557117628726757, 'k': 0.0074517815713840505, 'l': 0.03199556771356349, 'm': 0.01320682849129125, 'n': 0.04778558814363378, 'o': 0.05520274247723259, 'p': 0.010104227985733578, 'q': 0.0008656809446310467, 'r': 0.03670487205235638, 's': 0.04351951244849198, 't': 0.07075729769036324, 'u': 0.02356729803663562, 'v': 0.005574985283423942, 'w': 0.016884241144083937, 'x': 0.0009972644482149659, 'y': 0.014882786800096956, 'z': 0.0005332594618927248}, 'chesterton-ball.txt': {'a': 0.06375778773636463, 'b': 0.011491966335118592, 'c': 0.018447917805224614, 'd': 0.03326920974969942, 'e': 0.09167777899223958, 'f': 0.016390862389332166, 'g': 0.015770029511422014, 'h': 0.04736911137829271, 'i': 0.05058257733085583, 'j': 0.0005290195649797793, 'k': 0.006354792873538091, 'l': 0.03566510001093016, 'm': 0.017247786643349, 'n': 0.05474478085036616, 'o': 0.055761285386381025, 'p': 0.011876707836922068, 'q': 0.0008984588479615258, 'r': 0.04147557110066674, 's': 0.046381025248661056, 't': 0.06769920209859001, 'u': 0.024809268772543448, 'v': 0.006702371843917368, 'w': 0.017315553612416656, 'x': 0.001014318504754618, 'y': 0.01523663788392174, 'z': 0.00038255547054322876}, 'chesterton-brown.txt': {'a': 0.06343866276138692, 'b': 0.011354330360107124, 'c': 0.01814184428557727, 'd': 0.03310142660754644, 'e': 0.09180604433033551, 'f': 0.015505534529017852, 'g': 0.01504565586812549, 'h': 0.04797493538335928, 'i': 0.04966935462055092, 'j': 0.0007230177877131243, 'k': 0.007244933342186613, 'l': 0.03327849218821088, 'm': 0.01786394969370114, 'n': 0.05156051339181416, 'o': 0.05669787447525877, 'p': 0.012200310356614999, 'q': 0.0007869581362863938, 'r': 0.044268854410285545, 's': 0.047615885733678615, 't': 0.06771282913909239, 'u': 0.021906947118872484, 'v': 0.00626615416018041, 'w': 0.017649995450398276, 'x': 0.0010156678446446269, 'y': 0.014256238487663202, 'z': 0.000499226567706681}, 'chesterton-thursday.txt': {'a': 0.06447546993214258, 'b': 0.010682474065985492, 'c': 0.018544575306138365, 'd': 0.03313938070353326, 'e': 0.09545901255752282, 'f': 0.016747523594103423, 'g': 0.014916153186178924, 'h': 0.04785898135870837, 'i': 0.049578036034630686, 'j': 0.0005116605568988379, 'k': 0.007047812183137041, 'l': 0.034065985492551284, 'm': 0.0197238904921613, 'n': 0.0502581701895328, 'o': 0.05696591529521878, 'p': 0.012211215973792995, 'q': 0.0010701193354652524, 'r': 0.04313548085172764, 's': 0.0486701505342797, 't': 0.06748927540753451, 'u': 0.0222291552920989, 'v': 0.00643631542001404, 'w': 0.016663286795101786, 'x': 0.0009359644333515327, 'y': 0.017309102254114344, 'z': 0.0002839092114499649}, 'edgeworth-parents.txt': {'a': 0.05821796958374948, 'b': 0.010952159955857728, 'c': 0.015825133292983646, 'd': 0.03194861189232194, 'e': 0.0881605033587907, 'f': 0.014736547193094644, 'g': 0.013797668415390768, 'h': 0.04809133857594118, 'i': 0.04477746006557181, 'j': 0.0006608508936457796, 'k': 0.0062053685045735585, 'l': 0.02939396337303429, 'm': 0.01834984034783427, 'n': 0.04724228419154838, 'o': 0.05872162778910088, 'p': 0.011971239084732205, 'q': 0.0006041759788185526, 'r': 0.04246127392376475, 's': 0.04567998135074501, 't': 0.06314868717371824, 'u': 0.022915913674480676, 'v': 0.0063946413333361846, 'w': 0.017692197468235315, 'x': 0.001132428958528933, 'y': 0.016803577577265017, 'z': 0.0002801665600893111}, 'melville-moby_dick.txt': {'a': 0.06055237773433415, 'b': 0.012430510301772339, 'c': 0.017184369946660873, 'd': 0.03014344443639933, 'e': 0.09320670319149792, 'f': 0.01611356487180106, 'g': 0.016235046138746087, 'h': 0.04942437187748896, 'i': 0.04979203372513053, 'j': 0.0006669402006452184, 'k': 0.006341161232190122, 'l': 0.033703408716079776, 'm': 0.01812162607905132, 'n': 0.05183549344725219, 'o': 0.05497872066549208, 'p': 0.0130387211481991, 'q': 0.000992767439802412, 'r': 0.04128029992196237, 's': 0.0498974247580431, 't': 0.06881712644510414, 'u': 0.021284966089831776, 'v': 0.006779620109574494, 'w': 0.01682797126284202, 'x': 0.000810143283534059, 'y': 0.013308232568242704, 'z': 0.00047787995076388386}, 'milton-paradise.txt': {'a': 0.05265687070180684, 'b': 0.010001708598522062, 'c': 0.015537567810003844, 'd': 0.035822903763188245, 'e': 0.09571355345777625, 'f': 0.01715005766520012, 'g': 0.01544359489129042, 'h': 0.0503951134082269, 'i': 0.04744350946136432, 'j': 0.0008521635128785613, 'k': 0.004233052838409294, 'l': 0.03203622228866772, 'm': 0.017660501473666226, 'n': 0.05240912391610781, 'o': 0.05578787749348597, 'p': 0.01233608132928965, 'q': 0.0005232582973815728, 'r': 0.04840673187817693, 's': 0.04890649694588014, 't': 0.06315834436803212, 'u': 0.022890948699329373, 'v': 0.008021870061082396, 'w': 0.016440989278544274, 'x': 0.0009653581649651873, 'y': 0.010821835889111956, 'z': 0.0003780274230062791}, 'shakespeare-caesar.txt': {'a': 0.05424272103997863, 'b': 0.008449826373430683, 'c': 0.010978541536817737, 'd': 0.027201495859674116, 'e': 0.09485353040690944, 'f': 0.012055916659246728, 'g': 0.009527201495859674, 'h': 0.04151900988335856, 'i': 0.04118066067135607, 'j': 8.903926631644555e-06, 'k': 0.006482058587837236, 'l': 0.029837058142640906, 'm': 0.01870714985308521, 'n': 0.04354910515537352, 'o': 0.057314575727896, 'p': 0.008316267473956014, 'q': 0.00023150209242275843, 'r': 0.044813462737067045, 's': 0.0509393642596385, 't': 0.059745347698334964, 'u': 0.03371917015403793, 'v': 0.002243789511174428, 'w': 0.013970260885050307, 'x': 0.0005520434511619624, 'y': 0.017433888344760038, 'z': 0.00021369423915946933}, 'shakespeare-hamlet.txt': {'a': 0.051424045775750396, 'b': 0.008318956784400882, 'c': 0.012303460808811341, 'd': 0.026989028800166993, 'e': 0.09900479491162259, 'f': 0.013046334440481087, 'g': 0.01187369920371314, 'h': 0.04456013899718199, 'i': 0.04331383034239721, 'j': 6.1394515014028645e-06, 'k': 0.006188567113414088, 'l': 0.030218380289904898, 'm': 0.02177049502397456, 'n': 0.045217060307832097, 'o': 0.0617260453951044, 'p': 0.009092527673577643, 'q': 0.0004297616050982005, 'r': 0.042644630128744296, 's': 0.04335680650290703, 't': 0.06199004180966473, 'u': 0.028229198003450372, 'v': 0.002302294313026074, 'w': 0.014740823054868278, 'x': 0.0008411048556921924, 'y': 0.017528134036505178, 'z': 0.0002946936720673375}, 'shakespeare-macbeth.txt': {'a': 0.05294416597741926, 'b': 0.01043337884027065, 'c': 0.016402427479546792, 'd': 0.028330559735328994, 'e': 0.10096561070642046, 'f': 0.012844914350629292, 'g': 0.011698936732070432, 'h': 0.046446971131329035, 'i': 0.03841516277864695, 'j': 0.0, 'k': 0.006128489003597373, 'l': 0.0295861526043587, 'm': 0.01734910464270411, 'n': 0.04639714601747865, 'o': 0.05713944056362169, 'p': 0.008759255014897709, 'q': 0.00100646729977778, 'r': 0.041763410429392835, 's': 0.04314854859443354, 't': 0.06028838775896603, 'u': 0.027094896911839444, 'v': 0.0024215005331287183, 'w': 0.014170262379049536, 'x': 0.0009765722314675489, 'y': 0.01634263734292633, 'z': 0.0002291955237117717}, 'whitman-leaves.txt': {'a': 0.056908248560561855, 'b': 0.009608908698494829, 'c': 0.016156858333977772, 'd': 0.03065739614603179, 'e': 0.09319122909387456, 'f': 0.018042364123366354, 'g': 0.017194519238205044, 'h': 0.04479376841039629, 'i': 0.04532525326378099, 'j': 0.0007381734074787511, 'k': 0.0052389221262206225, 'l': 0.034040339419162985, 'm': 0.019684624199433363, 'n': 0.05343813052311889, 'o': 0.058017617738658496, 'p': 0.012404125334814367, 'q': 0.0005075820954282461, 'r': 0.046642717040557356, 's': 0.05286446433216397, 't': 0.06363617190301105, 'u': 0.021355005167213854, 'v': 0.007385952208544533, 'w': 0.014307909703816709, 'x': 0.0006608409552666915, 'y': 0.01489844842979971, 'z': 0.00044149799990157685}, 'cats.txt': {'a': 0.029865675907402117, 'b': 0.024864246927693626, 'c': 0.08473849671334667, 'd': 0.021863389539868532, 'e': 0.12646470420120035, 'f': 0.011860531580451557, 'g': 0.0174335524435553, 'h': 0.010717347813661047, 'i': 0.031008859674192625, 'j': 0.011431837667905115, 'k': 0.004144041154615604, 'l': 0.060160045727350675, 'm': 0.014004001143183767, 'n': 0.04701343240925979, 'o': 0.03300943126607602, 'p': 0.004144041154615604, 'q': 0.0, 'r': 0.0563018005144327, 's': 0.039582737925121465, 't': 0.04215490140040012, 'u': 0.0054301228922549296, 'v': 0.010860245784509859, 'w': 0.00871677622177765, 'x': 0.0, 'y': 0.00685910260074307, 'z': 0.0}}
        """
        self.corpus_caracters_frequency = {}
        frequency_of_each_corpus_sum = []

        for corpus in corpus_names:
            nltk.download(corpus)
            file = nltk.data.find("corpora/" + corpus)
            new_corpus = nltk.corpus.PlaintextCorpusReader(file, r'.*\.txt',
                                                           encoding="latin-1")
            for fileid in new_corpus.fileids():
                print("loading file " + fileid + " from corpus " + corpus)
                caracters_size_in_corpus = len(new_corpus.raw(fileids=fileid))
                alphabet_frequency = dict(
                    [(match, len([seq.start() for seq in
                                  re.finditer(match, new_corpus.raw(fileid))]) / caracters_size_in_corpus)
                     for match in self.alphabet])
                frequency_of_each_corpus_sum.append(alphabet_frequency)
                self.corpus_caracters_frequency[fileid] = alphabet_frequency

        final_frequency = {}
        for key in [k.keys() for k in frequency_of_each_corpus_sum][0]:
            final_frequency[key] = sum([k[key] for k in frequency_of_each_corpus_sum]) / len(frequency_of_each_corpus_sum)

        self.caracters_frequency = final_frequency